{% extends "base.html" %}
{% block title %}Consulta CNPJ/Cliente{% endblock %}

{% block content %}
<a href="{{ url_for('menu') }}" class="btn btn-outline-primary mb-3">Voltar ao Menu</a>
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h2 class="mb-0">Consulta CNPJ/Cliente</h2>
    </div>
    <div class="card-body">
        <form method="post" id="cnpjForm">
            <div class="mb-3">
                <label for="cnpj" class="form-label">CNPJ:</label>
                <input type="text" class="form-control" id="cnpj" name="cnpj" placeholder="Ex: 00.000.000/0000-00" required pattern="\d{2}\.?\d{3}\.?\d{3}/?\d{4}-?\d{2}|\d{14}" title="Formato: 00.000.000/0000-00 ou apenas 14 dígitos">
                <small class="form-text text-muted">Digite o CNPJ com ou sem pontuação.</small>
            </div>
            <button type="submit" class="btn btn-primary" id="consultarBtn">
                <i class="bi bi-search"></i> Consultar
            </button>
            <div id="loadingSpinner" class="spinner-border text-primary ms-3 d-none" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <span id="loadingText" class="ms-2 d-none">Consultando CNPJ...</span>
        </form>

        {% if cnpj_data %}
        <hr>
        <h5 class="mt-4">Dados do CNPJ:</h5>
        <div class="row">
            <div class="col-md-6">
                <p><strong>CNPJ:</strong> {{ cnpj_data.cnpj }}</p>
                <p><strong>Razão Social:</strong> {{ cnpj_data.razao_social }}</p>
                <p><strong>Nome Fantasia:</strong> {{ cnpj_data.nome_fantasia if cnpj_data.nome_fantasia else 'Não informado' }}</p>
                <p><strong>Atividade Principal:</strong> {{ cnpj_data.cnae_fiscal_descricao }}</p>
                <p><strong>Situação Cadastral:</strong> {{ cnpj_data.situacao_cadastral }}</p>
                <p><strong>Data Situação Cadastral:</strong> {{ cnpj_data.data_situacao_cadastral }}</p>
                <p><strong>Natureza Jurídica:</strong> {{ cnpj_data.natureza_juridica }}</p>
                <p><strong>Capital Social:</strong> {{ cnpj_data.capital_social|moeda_br }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Endereço:</strong> {{ cnpj_data.logradouro }}, {{ cnpj_data.numero }} {{ cnpj_data.complemento if cnpj_data.complemento else '' }}</p>
                <p><strong>Bairro:</strong> {{ cnpj_data.bairro }}</p>
                <p><strong>Município:</strong> {{ cnpj_data.municipio }} - {{ cnpj_data.uf }}</p>
                <p><strong>CEP:</strong> {{ cnpj_data.cep }}</p>
                <p><strong>Telefone:</strong> {{ cnpj_data.ddd_telefone_1 if cnpj_data.ddd_telefone_1 else 'Não informado' }}</p>
                <p><strong>Email:</strong> {{ cnpj_data.email if cnpj_data.email else 'Não informado' }}</p>
                <p><strong>Data Início Atividade:</strong> {{ cnpj_data.data_inicio_atividade }}</p>
            </div>
        </div>
        {% if cnpj_data.qsa %}
            <h6 class="mt-3">Quadro de Sócios e Administradores (QSA):</h6>
            <ul class="list-group" id="qsaList" data-total="{{ cnpj_data.qsa|length }}">
                {% for socio in cnpj_data.qsa[:5] %} {# Exibe os 5 primeiros inicialmente #}
                    <li class="list-group-item">
                        <strong>Nome:</strong> {{ socio.nome_socio }} <br>
                        <strong>Qualificacao:</strong> {{ socio.qualificacao_socio }}
                        {% if socio.cpf_cnpj_socio %}<br><strong>CPF/CNPJ:</strong> {{ socio.cpf_cnpj_socio }}{% endif %}
                        {% if socio.data_entrada_sociedade %}<br><strong>Entrada:</strong> {{ socio.data_entrada_sociedade }}{% endif %}
                    </li>
                {% endfor %}
                {% if cnpj_data.qsa|length > 5 %}
                <li class="list-group-item text-center">
                    <button type="button" class="btn btn-link btn-sm" id="verMaisQSA">Ver Mais ({{ cnpj_data.qsa|length - 5 }})</button>
                </li>
                {% endif %}
            </ul>
            <ul class="list-group d-none" id="qsaListHidden">
                {% for socio in cnpj_data.qsa %}
                    <li class="list-group-item">
                        <strong>Nome:</strong> {{ socio.nome_socio }} <br>
                        <strong>Qualificacao:</strong> {{ socio.qualificacao_socio }}
                        {% if socio.cpf_cnpj_socio %}<br><strong>CPF/CNPJ:</strong> {{ socio.cpf_cnpj_socio }}{% endif %}
                        {% if socio.data_entrada_sociedade %}<br><strong>Entrada:</strong> {{ socio.data_entrada_sociedade }}{% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
        {% endif %}

        <hr class="mt-4 mb-4">
        {# NOVO: Seção de Histórico de Consultas CNPJ #}
        <h5 class="mb-3">Histórico de Consultas CNPJ (Últimos 10)</h5>
        {% if historico_consultas %}
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover">
                <thead class="bg-primary text-white">
                    <tr>
                        <th>CNPJ</th>
                        <th>Razão Social</th>
                        <th>Nome Fantasia</th>
                        <th>Data da Consulta</th>
                        <th>Usuário</th>
                        {# REMOVIDO: <th>Ações</th> #}
                    </tr>
                </thead>
                <tbody>
                    {% for h in historico_consultas %}
                    <tr>
                        <td>{{ h.cnpj }}</td>
                        <td>{{ h.razao_social }}</td>
                        <td>{{ h.nome_fantasia }}</td>
                        <td>{{ h.data_consulta }}</td>
                        <td>{{ h.user_username }}</td>
                        {# REMOVIDO: Botão Ver Detalhes #}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            Nenhuma consulta CNPJ no histórico ainda.
        </div>
        {% endif %}
    </div>
</div>

{# REMOVIDO: Modal para exibir detalhes do histórico de CNPJ #}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cnpjForm = document.getElementById('cnpjForm');
    const consultarBtn = document.getElementById('consultarBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const loadingText = document.getElementById('loadingText');
    const cnpjInput = document.getElementById('cnpj');
    const verMaisQSABtn = document.getElementById('verMaisQSA');
    const qsaList = document.getElementById('qsaList');
    const qsaListHidden = document.getElementById('qsaListHidden');
    // REMOVIDO: const cnpjHistoryModal = new bootstrap.Modal(document.getElementById('cnpjHistoryModal'));
    // REMOVIDO: const cnpjHistoryModalBody = document.getElementById('cnpjHistoryModalBody');

    // Função para formatar CNPJ
    function formatCnpj(cnpj) {
        cnpj = cnpj.replace(/\D/g, '');
        if (cnpj.length > 12) {
            cnpj = cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
        } else if (cnpj.length > 8) {
            cnpj = cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})$/, '$1.$2.$3/$4');
        } else if (cnpj.length > 5) {
            cnpj = cnpj.replace(/^(\d{2})(\d{3})$/, '$1.$2');
        } else if (cnpj.length > 2) {
            cnpj = cnpj.replace(/^(\d{2})(\d{3})$/, '$1.$2');
        }
        return cnpj;
    }

    // Aplica a formatação ao digitar
    cnpjInput.addEventListener('input', function() {
        this.value = formatCnpj(this.value);
    });

    // Feedback visual ao submeter o formulário
    cnpjForm.addEventListener('submit', function() {
        consultarBtn.disabled = true;
        loadingSpinner.classList.remove('d-none');
        loadingText.classList.remove('d-none');
    });

    // Lógica para o botão "Ver Mais" do QSA
    if (verMaisQSABtn) {
        verMaisQSABtn.addEventListener('click', function() {
            qsaList.classList.add('d-none');
            qsaListHidden.classList.remove('d-none');
        });
    }

    // REMOVIDO: Lógica para exibir detalhes do histórico no modal (delegando o evento)
    /*
    document.querySelector('.table-responsive').addEventListener('click', function(event) {
        const button = event.target.closest('.view-history-btn'); 
        if (button) {
            let dataJson;
            try {
                dataJson = JSON.parse(button.dataset.json || '{}'); 
            } catch (e) {
                console.error("Erro ao parsear JSON do botão 'Ver Detalhes':", e);
                console.log("Conteúdo de data-json:", button.getAttribute('data-json'));
                alert("Erro ao carregar detalhes. JSON inválido ou ausente.");
                return;
            }
            
            let content = `
                <p><strong>CNPJ:</strong> ${dataJson.cnpj || 'Não informado'}</p>
                <p><strong>Razão Social:</strong> ${dataJson.razao_social || 'Não informado'}</p>
                // ... todo o resto do conteúdo do modal
            `;
            cnpjHistoryModalBody.innerHTML = content;
            cnpjHistoryModal.show();
        }
    });
    */
});
</script>
{% endblock %}